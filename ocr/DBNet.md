# [DBNet](https://www.jianshu.com/p/1eb20aad90b8)

![image-20230515155156926](/home/ly/.config/Typora/typora-user-images/image-20230515155156926.png)





![image-20230524094017677](/home/ly/.config/Typora/typora-user-images/image-20230524094017677.png)

1. é€šè¿‡å›å½’æ¥ï¼ŒåŒå›å½’æ¥è·å¾—æ¡†çš„åæ ‡
2. åŸºäºåˆ†å‰²çš„ï¼Œground truth åŸºäºå›¾åƒä¸­ä¸ºæ¯ä¸€ä¸ªåƒç´ ç‚¹éƒ½ç»™äºˆåˆ†ç±»ï¼Œäººè½¦æˆ¿å­æ ‘ï¼Œä¸Šçš„æ¯ä¸€ä¸ªåƒç´ ç‚¹éƒ½ç»™äºˆåˆ†ç±»ã€‚
   1. æ€ä¹ˆåš  -- FCN
   2. 

Deformable convolution -- æ‰©å¤§æ„Ÿå—é‡  --pytorchå°è£…å¥½äº†

![image-20230515155426898](/home/ly/.config/Typora/typora-user-images/image-20230515155426898.png) 

## 1. èƒŒæ™¯ä»‹ç»

> æ–‡æœ¬æ£€æµ‹åˆ†ä¸ºåŸºäºå›å½’å’ŒåŸºäºåˆ†å‰²ä¸¤ç§æ–¹æ³•ï¼ŒDBNet çš„åŸç†æ˜¯åŸºäºåˆ†å‰²ç®—æ³•ã€‚å¯¹äºä¸€èˆ¬åˆ†å‰²ç®—æ³•æµç¨‹ï¼šå…ˆé€šè¿‡ç½‘ç»œè¾“å‡ºæ–‡æœ¬åˆ†å‰²çš„æ¦‚ç‡å›¾ï¼Œç„¶åä½¿ç”¨è®¾å®šé˜ˆå€¼å°†æ¦‚ç‡å›¾è½¬åŒ–ä¸ºäºŒå€¼å›¾ï¼Œç„¶åé€šè¿‡åå¤„ç†å¾—åˆ°æ£€æµ‹ç»“æœï¼ˆæ–‡æœ¬æ¡†åæ ‡ï¼‰ã€‚ä½†æ˜¯ç¼ºç‚¹åœ¨äºé˜ˆå€¼çš„é€‰å–éå¸¸å…³é”®ã€‚

DBNet é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæå‡ºå¯å¾®åˆ†äºŒå€¼åŒ–çš„æ¦‚å¿µï¼šå³å¯¹æ¯ä¸€ä¸ªåƒç´ ç‚¹è¿›è¡Œè‡ªé€‚åº”äºŒå€¼åŒ–ï¼ŒäºŒå€¼åŒ–é˜ˆå€¼ç”±ç½‘ç»œå­¦ä¹ å¾—åˆ°ï¼Œå½»åº•å°†äºŒå€¼åŒ–è¿™ä¸€æ­¥éª¤åŠ å…¥åˆ°ç½‘ç»œé‡Œä¸€èµ·è®­ç»ƒï¼Œè¿™æ ·æœ€ç»ˆçš„è¾“å‡ºå›¾å¯¹äºé˜ˆå€¼å°±ä¼šéå¸¸é²æ£’ã€‚

**è‡ªé€‚åº”é˜ˆå€¼**

![img](https:////upload-images.jianshu.io/upload_images/1845179-286a4215a4f09883.png?imageMogr2/auto-orient/strip|imageView2/2/w/411/format/webp)



ä¸Šå›¾ä¸­è“çº¿éƒ¨åˆ†å°±æ˜¯ä¼ ç»Ÿçš„æ–‡æœ¬æ£€æµ‹ç®—æ³•æµç¨‹ï¼š

- é¦–å…ˆï¼Œé€šè¿‡è®¾ç½®ä¸€ä¸ªå›ºå®šé˜ˆå€¼å°†åˆ†å‰²ç½‘ç»œè®­ç»ƒå¾—åˆ°çš„æ¦‚ç‡å›¾(segmentation map)è½¬åŒ–ä¸ºäºŒå€¼å›¾(binarization map)ã€‚
- ç„¶åï¼Œä½¿ç”¨ä¸€äº›å¯å‘å¼æŠ€æœ¯(ä¾‹å¦‚åƒç´ èšç±»)å°†åƒç´ åˆ†ç»„ä¸ºæ–‡æœ¬å®ä¾‹ã€‚

ä¸Šå›¾çº¢è‰²éƒ¨åˆ†å°±æ˜¯ DBNet çš„ç®—æ³•æµç¨‹ï¼š

> é€šè¿‡åˆ†å‰²ç½‘ç»œè·å–æ¦‚ç‡å›¾å’Œé˜ˆå€¼å›¾ï¼Œé˜ˆå€¼å›¾æ˜¯ç½‘ç»œé¢„æµ‹å¾—å‡ºï¼Œå¹¶ä¸æ˜¯å›ºå®šçš„å€¼ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆå¥½å°†èƒŒæ™¯ä¸å‰æ™¯åˆ†ç¦»å‡ºæ¥ï¼Œä½†æ˜¯è¿™æ ·çš„æ“ä½œä¼šç»™è®­ç»ƒå¸¦æ¥æ¢¯åº¦ä¸å¯å¾®çš„æƒ…å†µï¼Œå¯¹æ­¤å¯¹äºäºŒå€¼åŒ–æå‡ºäº†ä¸€ä¸ªå«åš **Differentiable Binarization**æ¥è§£å†³ä¸å¯å¾®çš„é—®é¢˜ã€‚

## 2. DBNet ç®—æ³•æ•´ä½“æ¶æ„

![img](https:////upload-images.jianshu.io/upload_images/1845179-3e65c57d573cfda1.png?imageMogr2/auto-orient/strip|imageView2/2/w/962/format/webp)

ä¸Šå›¾æ˜¯ DBNet æ¨¡å‹ç½‘ç»œç»“æ„ç¤ºæ„å›¾ï¼Œä¸»è¦åˆ†ä¸º 3 ä¸ªæ¨¡å—ï¼š

- **ç¬¬ä¸€æ¨¡å—ï¼ˆ1ï¼‰**ï¼šå·¦è¾¹çš„çº¢æ¡†ä½¿ç”¨çš„æ˜¯ä¸€ä¸ª **FPN**  ç»“æ„ï¼Œåˆ†ä¸ºè‡ªåº•å‘ä¸Šçš„å·ç§¯æ“ä½œä¸è‡ªé¡¶å‘ä¸‹çš„ä¸Šé‡‡æ ·ï¼Œä»¥æ­¤æ¥è·å–å¤šå°ºåº¦çš„ç‰¹å¾ã€‚1 å›¾ä¸‹é¢éƒ¨åˆ†æ˜¯ 3x3 çš„å·ç§¯æ“ä½œï¼ŒæŒ‰ç…§å·ç§¯å…¬å¼åˆ†åˆ«è·å–åŸå›¾å¤§å°æ¯”ä¾‹çš„ `1/2ã€1/4ã€1/8ã€1/16ã€1/32` çš„ç‰¹å¾å›¾ï¼›ç„¶åè‡ªé¡¶å‘ä¸‹è¿›è¡Œä¸Šé‡‡æ · x2ï¼Œç„¶åä¸è‡ªåº•å‘ä¸Šç”Ÿæˆçš„ç›¸åŒå¤§å°çš„ç‰¹å¾å›¾èåˆï¼›èåˆä¹‹åå†é‡‡ç”¨ 3x3 çš„å·ç§¯æ¶ˆé™¤ä¸Šé‡‡æ ·çš„æ··å æ•ˆåº”ï¼›æœ€åå¯¹æ¯å±‚è¾“å‡ºç»“æœè¿›è¡Œä¸Šé‡‡æ ·ï¼Œç»Ÿä¸€ä¸º 1/4 å¤§å°çš„ç‰¹å¾å›¾ã€‚
- **ç¬¬äºŒæ¨¡å—ï¼ˆ2ï¼‰**ï¼šå°† 1/4 å¤§å°çš„ç‰¹å¾å›¾ç»è¿‡ä¸€ç³»åˆ—å·ç§¯å’Œè½¬ç½®å·ç§¯çš„æœºæ„è·å–æ¦‚ç‡å›¾ **P** å’Œé˜ˆå€¼å›¾ **T**ï¼Œå¯å‚è€ƒ FCN ç½‘ç»œç»“æ„ï¼Œç›®çš„æ˜¯ç”Ÿæˆä¸åŸå›¾ä¸€æ ·å¤§å°çš„ç‰¹å¾å›¾ P å’Œ Tã€‚
- **ç¬¬ä¸‰æ¨¡å—ï¼ˆ3ï¼‰**ï¼šå°†ç‰¹å¾å›¾ P å’Œ T ç»è¿‡ **DB æ–¹æ³•**ï¼ˆåç»­ä»‹ç»ï¼‰å¾—åˆ°è¿‘ä¼¼äºŒå€¼å›¾ã€‚

ç»è¿‡ä¸Šé¢ä¸‰ä¸ªæ¨¡å—ï¼Œå¯ä»¥å¾—åˆ°æ¦‚ç‡å›¾ã€é˜ˆå€¼å›¾å’Œè¿‘ä¼¼äºŒå€¼å›¾ã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¯¹è¿™ä¸‰ä¸ªå›¾è¿›è¡Œç›‘ç£å­¦ä¹ ï¼Œæ›´æ–°å„ä¸ªæ¨¡å—çš„å‚æ•°ã€‚åœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼Œç›´æ¥ä½¿ç”¨æ¦‚ç‡å›¾ï¼Œç„¶åä½¿ç”¨å›ºå®šé˜ˆå€¼è·å–ç»“æœã€‚

ä¸‹é¢ä»‹ç»å¯å¾®äºŒå€¼åŒ–çš„å‘å±•æµç¨‹ï¼š

**æ ‡å‡†äºŒå€¼åŒ–**
 åœ¨ä¼ ç»Ÿçš„å›¾åƒåˆ†å‰²ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬è·å–æ¦‚ç‡å›¾åï¼Œä¼šä½¿ç”¨æ ‡å‡†äºŒå€¼åŒ–ï¼ˆStandard Binarizeï¼‰æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œå°†ä½äºé˜ˆå€¼çš„åƒç´ ç‚¹ç½®0ï¼Œé«˜äºé˜ˆå€¼çš„åƒç´ ç‚¹ç½®1ï¼Œå…¬å¼å¦‚ä¸‹ï¼š
 ![B_{i, j}=\left\{\begin{array}{c} 1, \text { if } P_{i, j}>=t \\ 0, \text { otherwise } \end{array}\right.](https://math.jianshu.com/math?formula=B_%7Bi%2C%20j%7D%3D%5Cleft%5C%7B%5Cbegin%7Barray%7D%7Bc%7D%201%2C%20%5Ctext%20%7B%20if%20%7D%20P_%7Bi%2C%20j%7D%3E%3Dt%20%5C%5C%200%2C%20%5Ctext%20%7B%20otherwise%20%7D%20%5Cend%7Barray%7D%5Cright.)
 ![t](https://math.jianshu.com/math?formula=t) æ˜¯é¢„å…ˆè®¾ç½®çš„é˜ˆå€¼ï¼Œ![ï¼ˆi,jï¼‰](https://math.jianshu.com/math?formula=%EF%BC%88i%2Cj%EF%BC%89)ä»£è¡¨çš„æ˜¯åƒç´ ç‚¹åæ ‡ä½ç½®ã€‚å¯è§æ ‡å‡†çš„äºŒå€¼åŒ–æ˜¯ä¸å¯å¾®çš„ï¼Œæ‰€ä»¥ä¹Ÿå°±æ— æ³•æ”¾å…¥åˆ°ç½‘ç»œä¸­è¿›è¡Œä¼˜åŒ–å­¦ä¹ ã€‚

**å¯å¾®äºŒå€¼åŒ–**
 å¯å¾®äºŒå€¼åŒ–å°±æ˜¯å°†æ ‡å‡†äºŒå€¼åŒ–ä¸­çš„é˜¶è·ƒå‡½æ•°è¿›è¡Œäº†è¿‘ä¼¼ï¼Œå…¬å¼å¦‚ä¸‹æ‰€ç¤ºï¼š
 ![\hat{\boldsymbol{B}}=\frac{1}{1+e^{-k\left(P_{i, j} - T_{i, j}\right)}}](https://math.jianshu.com/math?formula=%5Chat%7B%5Cboldsymbol%7BB%7D%7D%3D%5Cfrac%7B1%7D%7B1%2Be%5E%7B-k%5Cleft(P_%7Bi%2C%20j%7D%20-%20T_%7Bi%2C%20j%7D%5Cright)%7D%7D)
 å¯å¾®äºŒå€¼åŒ–æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª å¸¦ç³»æ•° k çš„ sigmoid å‡½æ•°ï¼Œå–å€¼èŒƒå›´ä¸º![(0,1)](https://math.jianshu.com/math?formula=(0%2C1))ï¼Œk æ˜¯è†¨èƒ€å› å­ï¼ˆç»éªŒå‹è®¾ç½®ä¸º50ï¼‰ã€‚![P_{i,j}](https://math.jianshu.com/math?formula=P_%7Bi%2Cj%7D) æ˜¯æŒ‡æ¦‚ç‡å›¾åƒç´ ç‚¹ï¼Œ![T_{i,j}](https://math.jianshu.com/math?formula=T_%7Bi%2Cj%7D) æ˜¯æŒ‡é˜ˆå€¼å›¾åƒç´ ç‚¹ã€‚

æ ‡å‡†äºŒå€¼åŒ–å’Œå¯å¾®äºŒå€¼åŒ–çš„å¯¹æ¯”å¦‚ä¸‹å›¾ (a) æ‰€ç¤ºï¼ŒSB æ›²çº¿ä»£è¡¨æ ‡å‡†äºŒå€¼åŒ–ï¼ŒDB ä»£è¡¨å¯å¾®äºŒå€¼åŒ–ï¼Œå¯ä»¥çœ‹åˆ°æ›²çº¿å˜å¾—æ›´ä¸ºå¹³æ»‘ï¼Œä¹Ÿå°±æ˜¯å¯å¾®ï¼š

![img](https:////upload-images.jianshu.io/upload_images/1845179-5928f1c6a6094c71.png?imageMogr2/auto-orient/strip|imageView2/2/w/414/format/webp)

é™¤äº†å¯å¾®ä¹‹å¤–ï¼ŒDB æ–¹æ³•ä¹Ÿä¼šæ”¹å–„ç®—æ³•çš„æ€§èƒ½ï¼Œåœ¨åå‘ä¼ æ’­æ˜¯æ¢¯åº¦çš„è®¡ç®—ä¸Šè¿›è¡Œè§‚å¯Ÿã€‚å½“ä½¿ç”¨äº¤å‰ç†µæŸå¤±ï¼ˆ![y=1](https://math.jianshu.com/math?formula=y%3D1)ä»£è¡¨æ–‡å­—åŒºåŸŸï¼‰æ—¶ï¼Œæ­£è´Ÿæ ·æœ¬çš„ loss åˆ†åˆ«ä¸º ![l_+](https://math.jianshu.com/math?formula=l_%2B) å’Œ ![l_-](https://math.jianshu.com/math?formula=l_-)ï¼Œå…¬å¼å¦‚ä¸‹ï¼š
![image-20230524165322540](/home/ly/.config/Typora/typora-user-images/image-20230524165322540.png)

å¯¹è¾“å…¥ ![x = P_{i, j}-T_{i, j}](https://math.jianshu.com/math?formula=x%20%3D%20P_%7Bi%2C%20j%7D-T_%7Bi%2C%20j%7D) æ±‚åå¯¼ï¼Œåˆ™ä¼šå¾—åˆ°ï¼š
 ![\frac{\delta l_{+}}{\delta x}=-k f(x) e^{-k x}, \\ \frac{\delta l_{-}}{\delta x}=-k f(x) ,](https://math.jianshu.com/math?formula=%5Cfrac%7B%5Cdelta%20l_%7B%2B%7D%7D%7B%5Cdelta%20x%7D%3D-k%20f(x)%20e%5E%7B-k%20x%7D%2C%20%5C%5C%20%5Cfrac%7B%5Cdelta%20l_%7B-%7D%7D%7B%5Cdelta%20x%7D%3D-k%20f(x)%20%2C)

å¯ä»¥çœ‹åˆ° å¢å¼ºå› å­k å¯¹äºé”™è¯¯é¢„æµ‹å¯¹æ¢¯åº¦çš„å½±å“å˜å¤§äº†ï¼Œä»è€Œå¯ä»¥ä¿ƒè¿›æ¨¡å‹çš„ä¼˜åŒ–è¿‡ç¨‹äº§ç”Ÿæ›´ä¸ºæ¸…æ™°çš„é¢„æµ‹ç»“æœã€‚å¯¹äº![x>0](https://math.jianshu.com/math?formula=x%3E0)æ—¶ï¼ŒæŒ‰ç…§ï¼ˆaï¼‰å›¾å±äºæ­£æ ·æœ¬ï¼ˆæ–‡å­—åŒºåŸŸï¼‰ï¼Œ![x<0](https://math.jianshu.com/math?formula=x%3C0)æ—¶å±äºè´Ÿæ ·æœ¬ï¼ˆéæ–‡å­—åŒºåŸŸï¼‰ã€‚
 ä¸Šå›¾ï¼ˆbï¼‰æ˜¯æŒ‡ ![l_{+}](https://math.jianshu.com/math?formula=l_%7B%2B%7D) çš„å¯¼æ•°æ›²çº¿ï¼Œå¦‚æœå‘ç”Ÿæ¼æŠ¥ï¼ˆæ­£æ ·æœ¬è¢«é¢„æµ‹ä¸ºè´Ÿæ ·æœ¬![x<0](https://math.jianshu.com/math?formula=x%3C0)ï¼‰ï¼Œå›¾ï¼ˆbï¼‰å°äº 0 çš„éƒ¨åˆ†å¯¼æ•°éå¸¸å¤§ï¼Œè¯æ˜æŸå¤±ä¹Ÿæ˜¯éå¸¸å¤§çš„ï¼Œåˆ™æ›´èƒ½æ¸…æ™°çš„è¿›è¡Œæ¢¯åº¦å›ä¼ ã€‚åŒç†ï¼Œå›¾ï¼ˆcï¼‰ä»£è¡¨ ![l_{-}](https://math.jianshu.com/math?formula=l_%7B-%7D)çš„å¯¼æ•°æ›²çº¿ï¼Œå½“å‘ç”Ÿè¯¯æŠ¥ï¼ˆè´Ÿæ ·æœ¬è¢«é¢„æµ‹ä¸ºæ­£æ ·æœ¬![x>0](https://math.jianshu.com/math?formula=x%3E0)ï¼‰ï¼Œå¯¼æ•°ä¹Ÿæ˜¯éå¸¸å¤§çš„ï¼ŒæŸå¤±ä¹Ÿæ¯”è¾ƒå¤§ã€‚

## 3. çœŸå®æ ‡ç­¾ç”Ÿæˆ

DB ç½‘ç»œä¸­ï¼Œè®­ç»ƒè¿‡ç¨‹ä¸­ç½‘ç»œæœ‰ 3 ä¸ªè¾“å‡ºï¼šæ¦‚ç‡å›¾ã€é˜ˆå€¼å›¾å’Œè¿‘ä¼¼äºŒå€¼å›¾ï¼š

- æ¦‚ç‡å›¾ï¼šå›¾ä¸­æ¯ä¸ªåƒç´ ç‚¹çš„å€¼ä¸ºè¯¥ä½ç½®å±äºæ–‡æœ¬åŒºåŸŸçš„æ¦‚ç‡ã€‚
- é˜ˆå€¼å›¾ï¼šå›¾ä¸­æ¯ä¸ªåƒç´ ç‚¹çš„å€¼ä¸ºè¯¥ä½ç½®çš„äºŒå€¼åŒ–é˜ˆå€¼ã€‚
- è¿‘ä¼¼äºŒå€¼å›¾ï¼šç”±æ¦‚ç‡å›¾å’Œé˜ˆå€¼å›¾é€šè¿‡ DB ç®—æ³•è®¡ç®—å¾—åˆ°ï¼Œå›¾ä¸­åƒç´ çš„å€¼ä¸º 0 æˆ– 1ã€‚

æ¦‚ç‡å›¾çš„æ ‡ç­¾ ![G_{s}](https://math.jianshu.com/math?formula=G_%7Bs%7D)å’Œé˜ˆå€¼å›¾æ ‡ç­¾![G_{d}](https://math.jianshu.com/math?formula=G_%7Bd%7D)ï¼ŒDB ç½‘ç»œå‚è€ƒ PSENet ä¸­çš„æ–¹æ³•ï¼Œä½¿ç”¨æ‰©å¼ å’Œæ”¶ç¼©çš„æ–¹å¼æ„å»ºé˜ˆå€¼å›¾å’Œæ¦‚ç‡å›¾ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå¯¹äºä¸€å¹…æ–‡å­—å›¾åƒï¼Œæ–‡æœ¬åŒºåŸŸçš„æ¯ä¸ªå¤šè¾¹å½¢ä½¿ç”¨ä¸€ç»„çº¿æ®µ![G=\left\{S_{k}\right\}_{k=1}^{n}](https://math.jianshu.com/math?formula=G%3D%5Cleft%5C%7BS_%7Bk%7D%5Cright%5C%7D_%7Bk%3D1%7D%5E%7Bn%7D) æ¥è¿›è¡Œæè¿°ï¼Œ n ä¸ºçº¿æ®µä¸ªæ•°ã€‚

**æ¦‚ç‡å›¾æ ‡ç­¾![G_{s}](https://math.jianshu.com/math?formula=G_%7Bs%7D)**
 å¯¹äºæ¦‚ç‡å›¾å’Œè¿‘ä¼¼äºŒå€¼å›¾æ¥è¯´ï¼Œä½¿ç”¨æ”¶ç¼©çš„æ–¹å¼æ„å»ºæ ‡ç­¾ï¼ˆVatti clippingç®—æ³•ï¼‰ï¼Œæ”¶ç¼©çš„åç§»é‡Dç”±å¤šè¾¹å½¢çš„å‘¨é•¿ L å’Œé¢ç§¯ A è®¡ç®—å¾—åˆ°ï¼Œå…¬å¼å¦‚ä¸‹ï¼šå…¶ä¸­ï¼Œ r æ˜¯æ”¶ç¼©å› å­ï¼Œå®éªŒä¸­ç»éªŒè®¾ç½®ä¸º 0.4 ã€‚
 ![D=\frac{A\left(1-r^{2}\right)}{L}](https://math.jianshu.com/math?formula=D%3D%5Cfrac%7BA%5Cleft(1-r%5E%7B2%7D%5Cright)%7D%7BL%7D)

**é˜ˆå€¼å›¾æ ‡ç­¾![G_{d}](https://math.jianshu.com/math?formula=G_%7Bd%7D)**

- é¦–å…ˆä½¿ç”¨![G_{s}](https://math.jianshu.com/math?formula=G_%7Bs%7D)è®¡ç®—è¿‡ç¨‹ä¸­çš„åç§»é‡ D è¿›è¡Œå¤šè¾¹å½¢çš„æ‰©å……ã€‚å¾—åˆ°![G_{s}](https://math.jianshu.com/math?formula=G_%7Bs%7D)å’Œ![G_{d}](https://math.jianshu.com/math?formula=G_%7Bd%7D)ä¹‹é—´çš„åŒºåŸŸã€‚
- è®¡ç®—ä¹‹é—´åŒºåŸŸåˆ°åŸå§‹æ¡†çš„è·ç¦»ï¼Œå¹¶å¾—åˆ°æœ€è¿‘è¾¹ï¼ˆé•¿æ–¹å½¢å°±æ˜¯ 4 æ¡è¾¹ï¼‰çš„è·ç¦»ã€‚æœ€å¤–é¢çš„å¤§æ¡†çº¿ä¸ŠåŒºåŸŸå’Œæœ€é‡Œé¢çš„å°æ¡†çº¿ä¸ŠåŒºåŸŸè®¡ç®—ä¸º D ï¼ŒåŸå§‹æ¡†ä½ç½®çš„è·ç¦»ä¸º 0ã€‚
- è¿›è¡Œç¬¬ä¸€æ¬¡çš„å½’ä¸€åŒ–ï¼ˆé™¤ä»¥Dï¼‰ï¼Œè¿™æ ·è·ç¦»æ§åˆ¶åˆ° [0,1] ä¹‹é—´ï¼Œå¹¶ä¸”æœ€ä¸­é—´çš„åŒºåŸŸè¶Šæ¥è¿‘0ï¼Œè¶Šé‡Œé¢å’Œè¶Šå¤–é¢çš„åŒºåŸŸè¶Šæ¥è¿‘1ã€‚ç„¶åä½¿ç”¨ 1-X æ“ä½œï¼Œè®©è¶Šä¸­å¿ƒçš„è·ç¦»ä¸º 1ï¼Œè¶Šè¾¹ç¼˜çš„è·ç¦»ä¸º 0ã€‚ï¼ˆè¿™æ ·å›¾ç‰‡æ˜¾ç¤ºå°±æ˜¯ä¸­é—´äº®ä¸¤å¤´æš—ï¼‰ã€‚
- æœ€ç»ˆå†è¿›è¡Œç¼©æ”¾ï¼Œæ¯”å¦‚å½’ä¸€åŒ–åˆ° [0.3ï¼Œ0.7] çš„å€¼ã€‚

## 4. æŸå¤±å‡½æ•°

> ç”±äºåœ¨è®­ç»ƒé˜¶æ®µè¾“å‡º 3 ä¸ªé¢„æµ‹å›¾ï¼ˆå¤§å°ä¸åŸå›¾ä¸€è‡´ï¼‰ï¼Œæ‰€ä»¥åœ¨æŸå¤±å‡½æ•°ä¸­ï¼Œä¹Ÿéœ€è¦æœ‰å¯¹åº”çš„çœŸå®æ ‡ç­¾å»æ„å»º 3  éƒ¨åˆ†æŸå¤±å‡½æ•°ã€‚æ€»çš„æŸå¤±å‡½æ•°çš„å…¬å¼å®šä¹‰å¦‚ä¸‹ï¼š
>  ![L=L_{b}+\alpha \times L_{s}+\beta \times L_{t}](https://math.jianshu.com/math?formula=L%3DL_%7Bb%7D%2B%5Calpha%20%5Ctimes%20L_%7Bs%7D%2B%5Cbeta%20%5Ctimes%20L_%7Bt%7D)
>  å…¶ä¸­ï¼Œ![L](https://math.jianshu.com/math?formula=L)ä¸ºæ€»çš„æŸå¤±ï¼Œ![L_{b}](https://math.jianshu.com/math?formula=L_%7Bb%7D)ä¸ºè¿‘ä¼¼äºŒå€¼å›¾çš„æŸå¤±ï¼Œä½¿ç”¨ Dice æŸå¤±ï¼›![L_{s}](https://math.jianshu.com/math?formula=L_%7Bs%7D)ä¸ºæ¦‚ç‡å›¾æŸå¤±ï¼Œä½¿ç”¨å¸¦ OHEM çš„ Dice æŸå¤±ï¼›![L_{t}](https://math.jianshu.com/math?formula=L_%7Bt%7D)ä¸ºé˜ˆå€¼å›¾æŸå¤±ï¼Œä½¿ç”¨é¢„æµ‹å€¼å’Œæ ‡ç­¾é—´çš„ ğ¿1 è·ç¦»ã€‚å…¶ä¸­ï¼Œğ›¼ å’Œ ğ›½ ä¸ºæƒé‡ç³»æ•°ã€‚
>  æ¥ä¸‹æ¥åˆ†æè¿™ 3 ä¸ªloss:
>  1ï¼‰é¦–å…ˆæ˜¯Dice Lossï¼ŒDice Lossæ˜¯æ¯”è¾ƒé¢„æµ‹ç»“æœè·Ÿæ ‡ç­¾ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼Œå¸¸ç”¨äºäºŒå€¼å›¾åƒåˆ†å‰²ã€‚
>  ![diceloss =1-\frac{2 \times intersection area }{total area}](https://math.jianshu.com/math?formula=diceloss%20%3D1-%5Cfrac%7B2%20%5Ctimes%20intersection%20area%20%7D%7Btotal%20area%7D)
>  2ï¼‰å…¶æ¬¡æ˜¯MaskL1 Lossï¼Œæ˜¯è®¡ç®—é¢„æµ‹å€¼å’Œæ ‡ç­¾é—´çš„ğ¿1è·ç¦»
>  3ï¼‰æœ€åæ˜¯Balance Lossï¼Œæ˜¯å¸¦OHEMçš„Dice Lossï¼Œç›®çš„æ˜¯ä¸ºäº†æ”¹å–„æ­£è´Ÿæ ·æœ¬ä¸å‡è¡¡çš„é—®é¢˜ã€‚OHEM ä¸ºä¸€ç§ç‰¹æ®Šçš„è‡ªåŠ¨é‡‡æ ·æ–¹å¼ï¼Œå¯ä»¥è‡ªåŠ¨çš„é€‰æ‹©éš¾æ ·æœ¬è¿›è¡Œlossçš„è®¡ç®—ï¼Œä»è€Œæå‡æ¨¡å‹çš„è®­ç»ƒæ•ˆæœã€‚
>
> **Dice Loss (è¿ç§»)**
>  ![dice loss=1-\frac{2|X \bigcap Y|}{|X|+|Y|}](https://math.jianshu.com/math?formula=dice%20loss%3D1-%5Cfrac%7B2%7CX%20%5Cbigcap%20Y%7C%7D%7B%7CX%7C%2B%7CY%7C%7D)
>  å…¶ä¸­ |Xâˆ©Y| æ˜¯Xå’ŒYä¹‹é—´çš„äº¤é›†ï¼Œ|X|å’Œ|Y|åˆ†è¡¨è¡¨ç¤ºXå’ŒYçš„å…ƒç´ çš„ä¸ªæ•°ï¼Œå…¶ä¸­ï¼Œåˆ†å­çš„ç³»æ•°ä¸º2ï¼Œæ˜¯å› ä¸ºåˆ†æ¯å­˜åœ¨é‡å¤è®¡ç®—Xå’ŒYä¹‹é—´çš„å…±åŒå…ƒç´ çš„åŸå› ã€‚
>  åŒæ—¶ï¼Œä¸€èˆ¬ä¼šåŠ å…¥å¹³æ»‘å› å­ï¼Œé˜²æ­¢åˆ†å­åˆ†æ¯å…¨ä¸º0ã€‚å¯¹äºåˆ†å‰²ä»»åŠ¡è€Œè¨€ï¼Œ|X| å’Œ |Y| ä»£è¡¨åˆ†å‰²çš„ ground truth å’Œ predict_maskã€‚
>
> è®¡ç®—æ­¥éª¤ï¼š
>
> - é¦–å…ˆï¼Œä½¿ç”¨é¢„æµ‹å›¾ predict_mask å’Œ ground truth ä¹‹é—´çš„ç‚¹ä¹˜ã€‚
>
>   ![img](https:////upload-images.jianshu.io/upload_images/1845179-7e7ce24b51a1634a.png?imageMogr2/auto-orient/strip|imageView2/2/w/517/format/webp)
>
> - é€å…ƒç´ ç›¸ä¹˜çš„ç»“æœå…ƒç´ çš„ç›¸åŠ å’Œã€‚
>
>   ![img](https:////upload-images.jianshu.io/upload_images/1845179-fbdff8ac3dc421c3.png?imageMogr2/auto-orient/strip|imageView2/2/w/499/format/webp)
>
> - è®¡ç®—|X|å’Œ|Y|ï¼Œè¿™é‡Œå¯ä»¥é‡‡ç”¨ç›´æ¥å…ƒç´ ç›¸åŠ ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨å…ƒç´ å¹³æ–¹æ±‚å’Œçš„æ–¹æ³•ï¼š
>
>   ![img](https:////upload-images.jianshu.io/upload_images/1845179-95b8f11a36e921d3.png?imageMogr2/auto-orient/strip|imageView2/2/w/502/format/webp)

## 5. æ¨¡å‹è®­ç»ƒæµç¨‹

ä»¥ PaddleOCR ([https://github.com/PaddlePaddle/PaddleOCR/blob/0791714b91/deploy/lite/readme.md](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2FPaddlePaddle%2FPaddleOCR%2Fblob%2F0791714b91%2Fdeploy%2Flite%2Freadme.md)) ä¸ºä¾‹ï¼Œæ¨¡å‹çš„è®­ç»ƒæµç¨‹åˆ†ä¸ºä»¥ä¸‹éƒ¨åˆ†ï¼š

- æ•°æ®é¢„å¤„ç†ï¼šä¸»è¦åŒ…æ‹¬è§£æå›¾ç‰‡ã€çœŸå®æ ‡ç­¾å¤„ç†ã€éšæœºè£å‰ªå’Œå›¾ç‰‡å¢å¼ºã€‚
- æ¨¡å‹ç»“æ„éƒ¨åˆ†ï¼šåˆ†ä¸º Backboneã€Neckã€Head éƒ¨åˆ†ã€‚
- loss éƒ¨åˆ†ï¼šåˆ†ä¸º ![æ¦‚ç‡å›¾ L_{s}ã€é˜ˆå€¼å›¾ L_{t}ã€è¿‘ä¼¼äºŒå€¼å›¾ L_{b}](https://math.jianshu.com/math?formula=%E6%A6%82%E7%8E%87%E5%9B%BE%20L_%7Bs%7D%E3%80%81%E9%98%88%E5%80%BC%E5%9B%BE%20L_%7Bt%7D%E3%80%81%E8%BF%91%E4%BC%BC%E4%BA%8C%E5%80%BC%E5%9B%BE%20L_%7Bb%7D)ã€‚
- metric éƒ¨åˆ†ï¼šç»è¿‡åå¤„ç†ä¹‹åè¿›è¡Œè¯„ä»·æŒ‡æ ‡çš„è®¡ç®—ã€‚

**5.1 æ•°æ®é¢„å¤„ç†**
 æ•°æ®é¢„å¤„ç†åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š
 DecodeImage è§£æå›¾ç‰‡ã€DetLabelEncode è§£æ label æ–‡ä»¶ã€IaaAugment è¿›è¡Œæ•°æ®å¢å¼ºã€EastRandomCropData éšæœºè£å‰ªï¼ˆè£å‰ªåˆ°æŒ‡å®š size (960, 960, 3)ï¼‰ã€MakeBorderMap é˜ˆå€¼å›¾çœŸå®æ ‡ç­¾ç”Ÿæˆï¼ˆbatch, 960, 960ï¼‰ã€MakeShrinkMap æ¦‚ç‡å›¾æ ‡ç­¾ç”Ÿæˆï¼ˆbatch, 960, 960ï¼‰ã€NormalizeImage å½’ä¸€åŒ–ã€ToCHWImage çº¬åº¦å˜åŒ–ä¸ºï¼ˆ3, 960, 960ï¼‰ã€KeepKeys æŒ‡å®šæ ¼å¼ã€‚

![img](https:////upload-images.jianshu.io/upload_images/1845179-dd5cbbf79634fac2.png?imageMogr2/auto-orient/strip|imageView2/2/w/1083/format/webp)

ç»è¿‡æ•°æ®é¢„å¤„ç† image å­—æ®µçš„å¤§å°å˜ä¸ºï¼ˆbatch, 3, 960, 960ï¼‰ã€‚

**5.2 æ¨¡å‹å‰å‘ä¼ æ’­**
 æ¨¡å‹ä¾æ¬¡ç»è¿‡ backboneï¼ˆMobileNetV3ï¼‰--> neckï¼ˆDBFPNï¼‰ --> headï¼ˆDBHeadï¼‰ æ­¥éª¤ï¼Œçº¬åº¦å˜åŒ–å¦‚ä¸‹æ‰€ç¤ºï¼š



```undefined
è¾“å…¥çš„ images sizeï¼š [2, 3, 960, 960]ï¼Œbatch ä¸º 2
backbone è¾“å‡º1ï¼šbackbone behind [2, 16, 240, 240]ï¼Œå°ºå¯¸å¯¹åº” 1/4
backbone è¾“å‡º2ï¼šbackbone behind [2, 24, 120, 120]ï¼Œå°ºå¯¸å¯¹åº” 1/8
backbone è¾“å‡º3ï¼šbackbone behind [2, 56, 60, 60]ï¼Œå°ºå¯¸å¯¹åº” 1/16
backbone è¾“å‡º4ï¼šbackbone behind [2, 480, 30, 30]ï¼Œå°ºå¯¸å¯¹åº” 1/32
neck è¾“å‡ºï¼šneck behind [2, 96, 240, 240]ï¼Œè¾“å‡º 1/4
head è¾“å‡ºï¼šhead behind [2, 3, 960, 960]ï¼Œä¸åŸå›¾å¤§å°ä¸€è‡´ï¼Œåˆ†åˆ«ä»£è¡¨ shrink_maps, threshold_maps, binary_mapsï¼Œå¤§å°éƒ½ä¸º [960, 960]
```

**5.3 åå¤„ç†**
 åå¤„ç†çš„é€»è¾‘æµç¨‹å¦‚ä¸‹ï¼š

- é¦–å…ˆï¼Œå¯¹æ¦‚ç‡å›¾è¿›è¡Œå›ºå®šé˜ˆå€¼å¤„ç†ï¼Œå¾—åˆ°åˆ†å‰²å›¾ã€‚
- å¯¹åˆ†å‰²å›¾è®¡ç®—è½®å»“ï¼Œéå†æ¯ä¸ªè½®å»“ï¼Œå»é™¤å¤ªå°çš„é¢„æµ‹ï¼›å¯¹æ¯ä¸ªè½®å»“è®¡ç®—åŒ…å›´çŸ©å½¢ï¼Œç„¶åè®¡ç®—è¯¥çŸ©å½¢çš„é¢„æµ‹scoreã€‚
- å¯¹çŸ©å½¢è¿›è¡Œåå‘shrinkæ“ä½œï¼Œå¾—åˆ°çœŸå®çŸ©å½¢å¤§å°ï¼›æœ€åè¿˜åŸåˆ°åŸå›¾ size å°±å¯ä»¥äº†ã€‚

ä¸‹é¢å¯¹ python ä»£ç è¿›è¡Œè§£æï¼š
 pred æ˜¯æ¨¡å‹çš„è¾“å‡ºï¼Œshape ä¸º ï¼ˆ1ï¼Œheight, weightï¼‰ï¼Œè®­ç»ƒé˜¶æ®µéƒ½ä¸ºï¼ˆ1ï¼Œ960ï¼Œ960ï¼‰ï¼Œæ¨ç†é˜¶æ®µåˆ™ä¸ä¸€å®šã€‚

![img](https:////upload-images.jianshu.io/upload_images/1845179-63efdb7943ddf531.png?imageMogr2/auto-orient/strip|imageView2/2/w/806/format/webp)

æŸ¥çœ‹ boxes_from_bitmap çš„ä»£ç ï¼š



```python
def boxes_from_bitmap(self, pred, _bitmap, dest_width, dest_height):
        '''
        _bitmap: single map with shape (1, H, W),
                whose values are binarized as {0, 1}
        '''

        bitmap = _bitmap
        height, width = bitmap.shape
        
        # findContours è·å–è½®å»“ï¼Œå¦‚é•¿æ–¹å½¢è·å–å››ç‚¹é¡¶ç‚¹åæ ‡
        outs = cv2.findContours((bitmap * 255).astype(np.uint8), cv2.RETR_LIST,
                                cv2.CHAIN_APPROX_SIMPLE)
        # py2ã€py3 ä¸åŒç‰ˆæœ¬çš„æƒ…å†µ
        if len(outs) == 3:
            img, contours, _ = outs[0], outs[1], outs[2]
        elif len(outs) == 2:
            contours, _ = outs[0], outs[1]
        
        # æ–‡æœ¬æ¡†æœ€å¤§æ•°é‡
        num_contours = min(len(contours), self.max_candidates)

        boxes = []
        scores = []
        for index in range(num_contours):
            contour = contours[index]
            #  è®¡ç®—æœ€å°åŒ…å›´çŸ©ï¼Œè·å–å››ä¸ªåæ ‡ç‚¹ï¼Œå·¦ä¸Šä¸ºèµ·ç‚¹ï¼ˆé¡ºæ—¶é’ˆï¼‰
            points, sside = self.get_mini_boxes(contour)
            # é•¿æ–¹å½¢ä¸­å®½é«˜æœ€å°å€¼è¿‡æ»¤
            if sside < self.min_size:
                continue
            points = np.array(points)
            # åˆ©ç”¨ points å†…éƒ¨é¢„æµ‹æ¦‚ç‡å€¼ï¼Œè®¡ç®—å‡ºä¸€ä¸ªscore,ä½œä¸ºå®ä¾‹çš„é¢„æµ‹æ¦‚ç‡
            score = self.box_score_fast(pred, points.reshape(-1, 2))
            # score å¾—åˆ†çš„è¿‡æ»¤
            if self.box_thresh > score:
                continue
            # shrinkåå‘è¿˜åŸï¼Œä¹‹å‰æ¦‚ç‡å›¾è¿›è¡Œäº†ç¼©æ”¾ï¼Œæ•…è¿˜åŸ
            box = self.unclip(points).reshape(-1, 1, 2)
            box, sside = self.get_mini_boxes(box)
            if sside < self.min_size + 2:
                continue
            box = np.array(box)
            
            # è¿˜åŸåˆ°åŸå§‹åæ ‡ï¼Œåå‘è¿˜åŸä¹‹åï¼Œè¿˜éœ€è¦è¿˜åŸåˆ°åŸå§‹å›¾ç‰‡ï¼ˆåŸå§‹å›¾ç‰‡åœ¨é¢„å¤„ç†æ—¶è¢«ç¼©æ”¾å¤„ç†ï¼‰
            box[:, 0] = np.clip(
                np.round(box[:, 0] / width * dest_width), 0, dest_width)
            box[:, 1] = np.clip(
                np.round(box[:, 1] / height * dest_height), 0, dest_height)
            boxes.append(box.astype(np.int16))
            scores.append(score)
        return np.array(boxes, dtype=np.int16), scores

def get_mini_boxes(self, contour):
        # è¿”å›ç‚¹é›† cnt çš„æœ€å°å¤–æ¥çŸ©å½¢ï¼š# å¾—åˆ°æœ€å°å¤–æ¥çŸ©å½¢çš„ï¼ˆä¸­å¿ƒ(x,y), (å®½,é«˜), æ—‹è½¬è§’åº¦ï¼‰
        bounding_box = cv2.minAreaRect(contour)
        # æ’åºï¼Œæœ€ç»ˆä»¥å·¦ä¸Šçš„åæ ‡ä¸ºèµ·ç‚¹ï¼Œé¡ºæ—¶é’ˆæ’åˆ—å››ä¸ªåæ ‡ç‚¹
        points = sorted(list(cv2.boxPoints(bounding_box)), key=lambda x: x[0])

        index_1, index_2, index_3, index_4 = 0, 1, 2, 3
        if points[1][1] > points[0][1]:
            index_1 = 0
            index_4 = 1
        else:
            index_1 = 1
            index_4 = 0
        if points[3][1] > points[2][1]:
            index_2 = 2
            index_3 = 3
        else:
            index_2 = 3
            index_3 = 2

        box = [
            points[index_1], points[index_2], points[index_3], points[index_4]
        ]
        return box, min(bounding_box[1])
```

## 6. æ¨¡å‹æ¨ç†æµç¨‹

å¦‚æœä¸è€ƒè™‘ labelï¼Œåˆ™å…¶å¤„ç†é€»è¾‘å’Œè®­ç»ƒé€»è¾‘æœ‰ä¸€ç‚¹ä¸ä¸€æ ·ï¼Œå…¶æŠŠå›¾ç‰‡ç»Ÿä¸€ resize åˆ°æŒ‡å®šçš„é•¿åº¦è¿›è¡Œé¢„æµ‹ã€‚

**æ•°æ®é¢„å¤„ç†**
 æ•°æ®é¢„å¤„ç†æ²¡æœ‰è®­ç»ƒé˜¶æ®µçš„æ•°æ®å¢å¼ºã€éšæœºè£å‰ªå’Œç”Ÿæˆæ ‡ç­¾éƒ¨åˆ†ï¼Œä½†æ˜¯ä¼šå­˜åœ¨ä¸€ä¸ª resize çš„æ“ä½œï¼Œå°†å®½é«˜è®¾ç½®ä¸º 32 çš„å€æ•°ã€‚

DetResizeForTest æ­¥éª¤å¦‚ä¸‹ï¼š
 1ï¼‰å¯¹å›¾ç‰‡è¿›è¡Œç­‰æ¯”ä¾‹çš„æ”¾ç¼©ï¼Œè®¾ç½®æœ€å¤§çš„å°ºå¯¸ä¸º 960ã€‚å¦‚ 3 å¼ å›¾ç‰‡åˆ†åˆ«ä¸º (720ï¼Œ1280)ã€(230ï¼Œ230)ã€(1150ï¼Œ720)ã€‚
 2ï¼‰å¯¹å›¾ç‰‡è¿›è¡Œæ”¾ç¼©ï¼Œä»¥æœ€å¤§è¾¹ä¸ºå‡†ï¼ˆæ“ä½œ960çš„ç›´æ¥æ”¾ç¼©åˆ° 960ï¼‰ï¼Œç¼©å°è‡³èƒ½è¢« 32 æ•´é™¤çš„æœ€å¤§å°ºå¯¸ã€‚åˆ™è¾“å‡ºï¼š(512ï¼Œ960ï¼Œ3)ã€(224ï¼Œ224ï¼Œ3)ã€(960ï¼Œ576ï¼Œ3)ã€‚ç”±äºå®½é«˜éƒ½ä¸º 32 çš„å€æ•°ï¼Œåˆ™æ”¾ç¼©çš„æ¯”ä¾‹ä¸ç»Ÿä¸€ï¼Œä½†å°½å¯èƒ½ç›¸å·®ä¸å¤§ã€‚

åç»­çš„æ“ä½œå°±ä¸è®­ç»ƒé˜¶æ®µä¸€è‡´ï¼Œé€šè¿‡ç½‘ç»œç»“æ„ï¼Œç„¶åè¿›è¡Œåå¤„ç†è·å¾—ç»“æœã€‚



# DBNet

ä»£ç ä¸­çš„è·¯å¾„æ”¹åŠ¨  --æ•°æ®è·¯å¾„data_pathå…¨éƒ¨æ”¹ä¸ºç»å¯¹è·¯å¾„ ï¼Œ 

é™¤äº†requirements å¤–  è¿˜è¦å®‰è£…addict

1. icdar2015.yaml   --data_path
2. icdar2015_resnet18_FPN_DBhead_polyLR.yaml
3. tools/train.py  --ä¸‹å›¾

![image-20230519153600605](/home/ly/.config/Typora/typora-user-images/image-20230519153600605.png)

 **error:**

File "/content/drive/MyDrive/DBNet.pytorch/models/backbone/shufflenetv2.py", line 7, in <module>    from torchvision.models.utils import load_state_dict_from_url ModuleNotFoundError: No module named 'torchvision.models.utils'

```

æŸ¥é˜…äº†torchvisionçš„ä»£ç åº“åï¼Œæœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼š

è¯·æ³¨æ„ï¼Œæ­¤è¯­æ³•ä»…é€‚ç”¨äºæ›´é«˜ç‰ˆæœ¬çš„ PyTorchã€‚

æ¥è‡ª .utils import load_state_dict_from_url çš„åŸå§‹ä»£ç ä¸é€‚ç”¨ã€‚æ‚¨ä¸èƒ½ä» .utils å¯¼å…¥ load_state_dict_from_urlã€‚

å°† .utils æ›´æ”¹ä¸º torch.hub å¯ä»¥è§£å†³é—®é¢˜ã€‚

from torch.hub import load_state_dict_from_url
```

